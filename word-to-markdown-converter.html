<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±¥æ­´æ›¸ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 60px 20px;
            margin: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .drop-zone p {
            font-size: 1.2em;
            color: #667eea;
            margin: 10px 0;
        }

        .file-list {
            margin: 0 30px 30px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .file-item span {
            flex: 1;
        }

        .extract-btn {
            display: block;
            margin: 0 30px 30px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .extract-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .extract-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            background: #f0f0f0;
            overflow-x: auto;
            border-bottom: 2px solid #667eea;
        }

        .tab {
            padding: 15px 25px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 4px;
        }

        .tab:hover {
            background: #d0d0d0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .data-display {
            display: grid;
            gap: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .field {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .field:last-child {
            border-bottom: none;
        }

        .field-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            min-width: 150px;
        }

        .field-value {
            color: #333;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .history-table th,
        .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .history-table th {
            background: #667eea;
            color: white;
        }

        .history-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .json-view {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* .view-toggle {
            margin-bottom: 20px;
        }

        .view-toggle button {
            padding: 10px 20px;
            margin-right: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle button:hover {
            background: #764ba2;
        }

        .view-toggle button.active {
            background: #764ba2;
            font-weight: bold;
        } */
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ å±¥æ­´æ›¸ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</h1>
            <p>å±¥æ­´æ›¸Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º</p>
        </div>

        <div class="drop-zone" id="dropZone">
            <p>ğŸ“ ã“ã“ã«å±¥æ­´æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p style="font-size: 0.9em; color: #999;">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <input type="file" id="fileInput" accept=".docx" multiple style="display: none;">
        </div>

        <div id="fileList" class="file-list"></div>

        <button id="extractBtn" class="extract-btn" style="display: none;">
            âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚’é–‹å§‹
        </button>

        <div id="tabs" class="tabs" style="display: none;"></div>
        <div id="tabContents"></div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const extractBtn = document.getElementById('extractBtn');
        const tabs = document.getElementById('tabs');
        const tabContents = document.getElementById('tabContents');
        let files = [];

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(newFiles) {
            const wordFiles = Array.from(newFiles).filter(f => f.name.endsWith('.docx'));
            files = [...files, ...wordFiles];
            displayFileList();
        }

        function displayFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '';
                extractBtn.style.display = 'none';
                return;
            }

            fileList.innerHTML = files.map((f, i) => `
                <div class="file-item">
                    <span>${f.name}</span>
                    <button onclick="removeFile(${i})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
            `).join('');

            extractBtn.style.display = 'block';
        }

        function removeFile(index) {
            files.splice(index, 1);
            displayFileList();
        }

        String.prototype.includesAll = function (chars) {
            return chars.split('').every(char => this.includes(char));
        };

        // Wordãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚»ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function extractResumeData(file) {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);

            // document.xmlã‚’å–å¾—
            const docXml = await zip.file("word/document.xml").async("text");
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(docXml, "text/xml");

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
            const tables = xmlDoc.getElementsByTagName("w:tbl");
            if (tables.length === 0) {
                throw new Error("ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }

            // æœ€åˆã®ãƒ†ãƒ¼ãƒ–ãƒ«(TABLE 0)ã‹ã‚‰å…¨ã‚»ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
            const table = tables[0];
            const rows = table.getElementsByTagName("w:tr");
            const cellTexts = [];

            for (let row of rows) {
                const cells = row.getElementsByTagName("w:tc");
                for (let cell of cells) {
                    const textElements = cell.getElementsByTagName("w:t");
                    let cellText = "";
                    for (let t of textElements) {
                        cellText += t.textContent;
                    }
                    cellTexts.push(cellText);
                }
            }

            console.log(cellTexts)

            const resumeData = {
                ä½œæˆæ—¥: cellTexts[1].split("å†™çœŸ")[0].trim() || "",
                åŸºæœ¬æƒ…å ±: {
                    ãµã‚ŠãŒãª: cellTexts[3].trim() || "",
                    æ°å: cellTexts[5].trim() || "",
                    ç”Ÿå¹´æœˆæ—¥å¹´é½¢: cellTexts[6].trim() || "",
                    ç¾ä½æ‰€ãµã‚ŠãŒãª: cellTexts[8].trim() || "",
                    ç¾ä½æ‰€éƒµä¾¿ç•ªå·: cellTexts[9].match(/[ï¼ˆ(](.*?)[)ï¼‰]/)?.[1].trim() || "",
                    ç¾ä½æ‰€: cellTexts[10].trim() || "",
                    Email: cellTexts[12].trim() || "",
                    é›»è©±: cellTexts[14].trim() || ""
                },
                å­¦æ­´: [],
                è·æ­´: [],
                å…è¨±è³‡æ ¼: [],
                å­¦ç”Ÿç”Ÿæ´»: "",
                è‡ªå·±PR: ""
            };


            let line = 15;
            while (cellTexts[line] !== undefined && !cellTexts[line].includesAll("å­¦æ­´è·æ­´")) line += 1;
            if (line >= cellTexts.length) {
                console.log(`å­¦æ­´ãƒ»è·æ­´ã®æ¬„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ ${file.name}`);
                return resumeData;
            }
            line += 1;

            // å­¦æ­´ãƒ»è·æ­´ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
            let histType = "å­¦æ­´"
            for (; cellTexts[line + 2] !== undefined && [0, 1, 2].every(e => !cellTexts[line + e].includesAll("å­¦ç”Ÿç”Ÿæ´»ã«ãŠã„ã¦åŠ›ã‚’å…¥ã‚Œã¦ã„ã‚‹ã“ã¨")); line += 3) {
                const year = cellTexts[line].trim();
                const month = cellTexts[line + 1].trim();
                const content = cellTexts[line + 2].trim();

                for (let htype of ["è·æ­´", "å…è¨±è³‡æ ¼"]) {
                    if (content.includesAll(htype)) {
                        histType = htype;
                        break;
                    }
                }
                if (content.length > 0 && ["å­¦æ­´", "è·æ­´", "å…è¨±è³‡æ ¼", "ãªã—", "ä»¥ä¸Š"].every(e => !content.includesAll(e))) {
                    if (year.length === 0 && month.length === 0 && resumeData[histType].length > 0) {
                        resumeData[histType][resumeData[histType].length - 1].å†…å®¹ += ` ${content}`;
                    } else {
                        resumeData[histType].push({
                            å¹´: year,
                            æœˆ: month,
                            å†…å®¹: content
                        })
                    }
                }
            }

            for (; line < cellTexts.length; line += 1) {
                for (let ptype of ["å­¦ç”Ÿç”Ÿæ´»", "è‡ªå·±PR"]) {
                    if (cellTexts[line].includesAll(ptype)) {
                        resumeData[ptype] = cellTexts[line + 1];
                        line += 1;
                        break;
                    }
                }
            }

            return resumeData;
        }

        function renderResumeData(data) {
            return `
                <div class="json-view">
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        async function copyImageToTemplate(sourceFile, templateFile, resumeData) {
            const sourceArrayBuffer = await sourceFile.arrayBuffer();
            const sourceZip = await JSZip.loadAsync(sourceArrayBuffer);

            const templateArrayBuffer = await templateFile.arrayBuffer();
            const templateZip = await JSZip.loadAsync(templateArrayBuffer);

            // 1. ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”»åƒã¨ãã®ä½ç½®æƒ…å ±ã‚’å–å¾—
            const sourceDocXml = await sourceZip.file("word/document.xml").async("text");
            const sourceParser = new DOMParser();
            const sourceXmlDoc = sourceParser.parseFromString(sourceDocXml, "text/xml");

            // ç”»åƒã®drawingè¦ç´ ã‚’å–å¾—
            const sourceDrawings = sourceXmlDoc.getElementsByTagName("w:drawing");
            if (sourceDrawings.length === 0) {
                console.log("ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return templateZip;
            }

            const sourceDrawing = sourceDrawings[0];

            // ç”»åƒã®å‚ç…§IDï¼ˆrIdï¼‰ã‚’å–å¾—
            const blips = sourceDrawing.getElementsByTagName("a:blip");
            if (blips.length === 0) {
                console.log("ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return templateZip;
            }

            const firstBlip = blips[0];
            const sourceImageRId = firstBlip.getAttributeNS("http://schemas.openxmlformats.org/officeDocument/2006/relationships", "embed");

            // 2. ç”»åƒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚»ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
            const sourceTables = sourceXmlDoc.getElementsByTagName("w:tbl");
            let sourceCellIndex = -1;

            if (sourceTables.length > 0) {
                const sourceTable = sourceTables[0];
                const sourceRows = sourceTable.getElementsByTagName("w:tr");
                const sourceCells = [];

                for (let row of sourceRows) {
                    const rowCells = row.getElementsByTagName("w:tc");
                    for (let cell of rowCells) {
                        sourceCells.push(cell);
                    }
                }

                // ã©ã®ã‚»ãƒ«ã«ç”»åƒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹æ¢ã™
                for (let i = 0; i < sourceCells.length; i++) {
                    const cellDrawings = sourceCells[i].getElementsByTagName("w:drawing");
                    if (cellDrawings.length > 0) {
                        sourceCellIndex = i;
                        break;
                    }
                }
            }

            if (sourceCellIndex === -1) {
                console.log("ç”»åƒã‚’å«ã‚€ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return templateZip;
            }

            console.log(`ç”»åƒã¯ã‚»ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${sourceCellIndex} ã«ã‚ã‚Šã¾ã™`);

            // 3. ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”»åƒã®ãƒ‘ã‚¹ã‚’å–å¾—
            const sourceRelsXml = await sourceZip.file("word/_rels/document.xml.rels").async("text");
            const sourceRelsDoc = sourceParser.parseFromString(sourceRelsXml, "text/xml");
            const sourceRelationships = sourceRelsDoc.getElementsByTagName("Relationship");

            let imageFileName = null;
            for (let rel of sourceRelationships) {
                if (rel.getAttribute("Id") === sourceImageRId) {
                    imageFileName = rel.getAttribute("Target").replace("media/", "");
                    break;
                }
            }

            if (!imageFileName) {
                console.log("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return templateZip;
            }

            // 4. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            const imageData = await sourceZip.file(`word/media/${imageFileName}`).async("blob");
            templateZip.file(`word/media/${imageFileName}`, imageData);

            // 5. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã«ç”»åƒã‚’è¿½åŠ 
            const templateRelsXml = await templateZip.file("word/_rels/document.xml.rels").async("text");
            const templateRelsDoc = sourceParser.parseFromString(templateRelsXml, "text/xml");
            const templateRelationships = templateRelsDoc.getElementsByTagName("Relationship");

            // æ–°ã—ã„rIdã‚’ç”Ÿæˆ
            let maxRId = 0;
            for (let rel of templateRelationships) {
                const id = rel.getAttribute("Id");
                const num = parseInt(id.replace("rId", ""));
                if (num > maxRId) maxRId = num;
            }
            const newRId = `rId${maxRId + 1}`;

            // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’è¿½åŠ 
            const newRel = templateRelsDoc.createElement("Relationship");
            newRel.setAttribute("Id", newRId);
            newRel.setAttribute("Type", "http://schemas.openxmlformats.org/officeDocument/2006/relationships/image");
            newRel.setAttribute("Target", `media/${imageFileName}`);
            templateRelsDoc.documentElement.appendChild(newRel);

            // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ï¼ˆXMLå®£è¨€ä»˜ãï¼‰
            const updatedRelsXml = serializeXmlWithDeclaration(templateRelsDoc);
            templateZip.file("word/_rels/document.xml.rels", updatedRelsXml);

            // 6. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®document.xmlã«ç”»åƒã‚’æŒ¿å…¥ï¼ˆåŒã˜ã‚»ãƒ«ä½ç½®ã«ï¼‰
            const templateDocXml = await templateZip.file("word/document.xml").async("text");
            const templateXmlDoc = sourceParser.parseFromString(templateDocXml, "text/xml");

            const tables = templateXmlDoc.getElementsByTagName("w:tbl");
            if (tables.length === 0) {
                return templateZip;
            }

            const table = tables[0];
            const rows = table.getElementsByTagName("w:tr");
            const cells = [];

            for (let row of rows) {
                const rowCells = row.getElementsByTagName("w:tc");
                for (let cell of rowCells) {
                    cells.push(cell);
                }
            }

            if (sourceCellIndex >= cells.length) {
                console.log("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¯¾å¿œã™ã‚‹ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return templateZip;
            }

            const targetCell = cells[sourceCellIndex];
            const targetParagraph = targetCell.getElementsByTagName("w:p")[0];

            // ã‚½ãƒ¼ã‚¹ã‹ã‚‰ç”»åƒã®XMLã‚’ãã®ã¾ã¾ã‚¯ãƒ­ãƒ¼ãƒ³
            const clonedDrawing = sourceDrawing.cloneNode(true);

            // ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸç”»åƒã®rIdã‚’æ–°ã—ã„ã‚‚ã®ã«ç½®ãæ›ãˆ
            const clonedBlips = clonedDrawing.getElementsByTagName("a:blip");
            for (let blip of clonedBlips) {
                blip.setAttributeNS("http://schemas.openxmlformats.org/officeDocument/2006/relationships", "r:embed", newRId);
            }

            // XMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé–“ã§ãƒãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            const importedDrawing = templateXmlDoc.importNode(clonedDrawing, true);

            // ç”»åƒã‚’æ®µè½ã«è¿½åŠ 
            const run = templateXmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:r");
            run.appendChild(importedDrawing);

            // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            while (targetParagraph.firstChild) {
                targetParagraph.removeChild(targetParagraph.firstChild);
            }

            targetParagraph.appendChild(run);

            // document.xmlã‚’æ›´æ–°ï¼ˆXMLå®£è¨€ä»˜ãï¼‰
            const updatedDocXml = serializeXmlWithDeclaration(templateXmlDoc);
            templateZip.file("word/document.xml", updatedDocXml);

            return templateZip;
        }

        // XMLå®£è¨€ä»˜ãã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹é–¢æ•°
        function serializeXmlWithDeclaration(xmlDoc) {
            const serializer = new XMLSerializer();
            let xmlString = serializer.serializeToString(xmlDoc);

            // XMLå®£è¨€ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
            if (!xmlString.startsWith('<?xml')) {
                xmlString = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n' + xmlString;
            }

            return xmlString;
        }

        async function writeResumeData(templateFile, sourceFile, resumeData) {
            let zip = await copyImageToTemplate(sourceFile, templateFile, resumeData);

            // const arrayBuffer = await templateFile.arrayBuffer();
            // const zip = await JSZip.loadAsync(arrayBuffer);

            // document.xmlã‚’å–å¾—
            const docXml = await zip.file("word/document.xml").async("text");
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(docXml, "text/xml");

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
            const tables = xmlDoc.getElementsByTagName("w:tbl");
            if (tables.length === 0) {
                throw new Error("ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }

            // æœ€åˆã®ãƒ†ãƒ¼ãƒ–ãƒ«(TABLE 0)ã‹ã‚‰å…¨ã‚»ãƒ«ã‚’å–å¾—
            const table = tables[0];
            const rows = table.getElementsByTagName("w:tr");
            const cells = [];

            for (let row of rows) {
                const rowCells = row.getElementsByTagName("w:tc");
                for (let cell of rowCells) {
                    cells.push(cell);
                }
            }

            // ã‚»ãƒ«ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹è£œåŠ©é–¢æ•°
            function setCellText(cellIndex, text, alignment = null) {
                if (cellIndex >= cells.length) return;

                const cell = cells[cellIndex];
                const drawings = cell.getElementsByTagName("w:drawing");
                if (drawings.length > 0) {
                    console.log(`ã‚»ãƒ« ${cellIndex} ã«ã¯ç”»åƒãŒã‚ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
                    return;
                }
                const textElements = cell.getElementsByTagName("w:t");

                if (textElements.length > 0) {
                    // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’æ›´æ–°
                    textElements[0].textContent = text;

                    if (text.includes(' ') || text.startsWith(' ') || text.endsWith(' ')) {
                        textElements[0].setAttributeNS("http://www.w3.org/XML/1998/namespace", "xml:space", "preserve");
                    }

                    // 2ã¤ç›®ä»¥é™ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã¯å‰Šé™¤ï¼ˆçµåˆã•ã‚ŒãŸã‚»ãƒ«ã®å ´åˆï¼‰
                    for (let i = textElements.length - 1; i > 0; i--) {
                        textElements[i].textContent = "";
                    }
                } else {
                    // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                    const paragraph = cell.getElementsByTagName("w:p")[0];
                    if (paragraph) {
                        const run = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:r");
                        const t = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:t");
                        t.textContent = text;

                        if (text.includes(' ') || text.startsWith(' ') || text.endsWith(' ')) {
                            t.setAttributeNS("http://www.w3.org/XML/1998/namespace", "xml:space", "preserve");
                        }
                        run.appendChild(t);
                        paragraph.appendChild(run);
                    }
                }

                // é…ç½®ã‚’è¨­å®š
                if (alignment) {
                    const paragraph = cell.getElementsByTagName("w:p")[0];
                    if (paragraph) {
                        // æ—¢å­˜ã®w:pPrï¼ˆæ®µè½ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
                        let pPr = paragraph.getElementsByTagName("w:pPr")[0];
                        if (!pPr) {
                            pPr = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pPr");
                            paragraph.insertBefore(pPr, paragraph.firstChild);
                        }

                        // æ—¢å­˜ã®w:jcï¼ˆé…ç½®ï¼‰ã‚’å‰Šé™¤
                        const existingJc = pPr.getElementsByTagName("w:jc");
                        while (existingJc.length > 0) {
                            existingJc[0].parentNode.removeChild(existingJc[0]);
                        }

                        // æ–°ã—ã„é…ç½®ã‚’è¨­å®š
                        // æ–°ã—ã„é…ç½®ã‚’è¨­å®š
                        const jc = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:jc");
                        jc.setAttribute("w:val", alignment);
                        pPr.appendChild(jc);
                    }
                }
            }
            // ã€Œç¾åœ¨ã€ã‚’ä½œæˆæ—¥ã§ç½®æ›
            function replaceTextInCell(cellIndex, searchText, replaceText) {
                if (cellIndex >= cells.length) return;

                const cell = cells[cellIndex];
                const textElements = cell.getElementsByTagName("w:t");

                for (let t of textElements) {
                    if (t.textContent.includes(searchText)) {
                        t.textContent = t.textContent.replace(searchText, replaceText);

                        if (t.textContent.includes(' ') || t.textContent.startsWith(' ') || t.textContent.endsWith(' ')) {
                            t.setAttributeNS("http://www.w3.org/XML/1998/namespace", "xml:space", "preserve");
                        }
                    }
                }
            }

            // ä½œæˆæ—¥ï¼ˆã€Œç¾åœ¨ã€ã‚’ç½®æ›ï¼‰
            replaceTextInCell(1, "ç¾åœ¨", resumeData.ä½œæˆæ—¥);

            // åŸºæœ¬æƒ…å ±
            setCellText(3, resumeData.åŸºæœ¬æƒ…å ±.ãµã‚ŠãŒãª);
            setCellText(5, resumeData.åŸºæœ¬æƒ…å ±.æ°å);
            setCellText(6, resumeData.åŸºæœ¬æƒ…å ±.ç”Ÿå¹´æœˆæ—¥å¹´é½¢);
            setCellText(8, resumeData.åŸºæœ¬æƒ…å ±.ç¾ä½æ‰€ãµã‚ŠãŒãª);

            // ç¾ä½æ‰€éƒµä¾¿ç•ªå·ï¼ˆã€’ã‚’ç½®æ›ï¼‰
            replaceTextInCell(9, "ã€’", resumeData.åŸºæœ¬æƒ…å ±.ç¾ä½æ‰€éƒµä¾¿ç•ªå·);

            setCellText(10, resumeData.åŸºæœ¬æƒ…å ±.ç¾ä½æ‰€);
            setCellText(12, resumeData.åŸºæœ¬æƒ…å ±.Email);
            setCellText(14, resumeData.åŸºæœ¬æƒ…å ±.é›»è©±);

            // å­¦æ­´ãƒ»è·æ­´ãƒ»å…è¨±è³‡æ ¼ã®æ›¸ãè¾¼ã¿é–‹å§‹ä½ç½®ã‚’æ¢ã™
            let line = 15;

            for (let i = line; i < cells.length; i++) {
                const cell = cells[i];
                const textElements = cell.getElementsByTagName("w:t");
                let cellText = "";
                for (let t of textElements) {
                    cellText += t.textContent;
                }

                if (cellText.includesAll("å­¦æ­´è·æ­´")) {
                    line = i + 1;


                    setCellText(line + 2, "å­¦æ­´", "center");
                    line += 3;

                    // å­¦æ­´ã‚’æ›¸ãè¾¼ã¿
                    for (let item of resumeData.å­¦æ­´) {
                        setCellText(line, item.å¹´);
                        setCellText(line + 1, item.æœˆ);
                        setCellText(line + 2, item.å†…å®¹);
                        line += 3;
                    }

                    // ã€Œè·æ­´ã€ãƒ©ãƒ™ãƒ«ã‚’æ›¸ãè¾¼ã¿
                    setCellText(line + 2, "è·æ­´", "center");
                    line += 3;
                    if (resumeData.è·æ­´.length > 0) {

                        // è·æ­´ã‚’æ›¸ãè¾¼ã¿
                        for (let item of resumeData.è·æ­´) {
                            setCellText(line, item.å¹´);
                            setCellText(line + 1, item.æœˆ);
                            setCellText(line + 2, item.å†…å®¹);
                            line += 3;
                        }
                    } else {
                        setCellText(line + 2, "ãªã—");
                        line += 3;
                    }
                    setCellText(line + 2, "ä»¥ä¸Š", "right");


                    break;
                }
            }
            for (let i = line; i < cells.length; i++) {
                const cell = cells[i];
                const textElements = cell.getElementsByTagName("w:t");
                let cellText = "";
                for (let t of textElements) {
                    cellText += t.textContent;
                }

                if (cellText.includesAll("å…è¨±è³‡æ ¼")) {
                    line = i + 1;

                    for (let item of resumeData.å…è¨±è³‡æ ¼) {
                        setCellText(line, item.å¹´);
                        setCellText(line + 1, item.æœˆ);
                        setCellText(line + 2, item.å†…å®¹);
                        line += 3;
                    }

                    break;
                }
            }

            // å­¦ç”Ÿç”Ÿæ´»ã¨è‡ªå·±PRã‚’æ›¸ãè¾¼ã¿
            let dones = { å­¦ç”Ÿç”Ÿæ´»: false, è‡ªå·±PR: false };
            for (let i = line; i < cells.length; i++) {
                const cell = cells[i];
                const textElements = cell.getElementsByTagName("w:t");
                let cellText = "";
                for (let t of textElements) {
                    cellText += t.textContent;
                }

                if (dones.å­¦ç”Ÿç”Ÿæ´» === false && cellText.includesAll("å­¦ç”Ÿç”Ÿæ´»")) {
                    setCellText(i + 1, resumeData.å­¦ç”Ÿç”Ÿæ´»);
                    dones.å­¦ç”Ÿç”Ÿæ´» = true;
                }
                if (dones.è‡ªå·±PR === false && cellText.includesAll("è‡ªå·±PR")) {
                    setCellText(i + 1, resumeData.è‡ªå·±PR);
                    dones.è‡ªå·±PR = true;
                }
            }

            // XMLã‚’æ–‡å­—åˆ—ã«æˆ»ã™
            const serializer = new XMLSerializer();
            const modifiedXml = serializer.serializeToString(xmlDoc);

            // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
            zip.file("word/document.xml", serializeXmlWithDeclaration(xmlDoc));

            // æ–°ã—ã„docxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            const blob = await zip.generateAsync({ type: "blob" });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'è¨˜å…¥æ¸ˆã¿_' + resumeData.åŸºæœ¬æƒ…å ±.æ°å + '_å±¥æ­´æ›¸.docx';
            a.click();
            URL.revokeObjectURL(url);

            return blob;
        }

        extractBtn.addEventListener('click', async () => {
            extractBtn.disabled = true;
            extractBtn.textContent = 'æŠ½å‡ºä¸­...';

            tabs.style.display = 'flex';
            tabs.innerHTML = '';
            tabContents.innerHTML = '';

            const extractedData = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const tabId = `tab-${i}`;
                const contentId = `content-${i}`;

                const tab = document.createElement('button');
                tab.id = tabId;
                tab.className = 'tab' + (i === 0 ? ' active' : '');
                tab.textContent = file.name.replace('.docx', '');
                tab.onclick = () => switchTab(i);
                tabs.appendChild(tab);

                const content = document.createElement('div');
                content.id = contentId;
                content.className = 'tab-content' + (i === 0 ? ' active' : '');
                content.innerHTML = '<div class="loading"><div class="spinner"></div><p>æŠ½å‡ºä¸­...</p></div>';
                tabContents.appendChild(content);

                try {
                    const data = await extractResumeData(file);
                    extractedData.push({ filename: file.name, data: data });

                    content.innerHTML = `
                        <button id="writeDocx${i}" class="extract-btn">
                            ğŸ“ƒæ–°è¦ãƒ¯ãƒ¼ãƒ‰ã«æ›¸ãè¾¼ã¿
                        </button>
                        <div id="view-${i}">
                            ${renderResumeData(data)}
                        </div>
                    `;
                    document.querySelector(`#writeDocx${i}`).addEventListener('click', e => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.docx';
                        input.onchange = async (e) => {
                            await writeResumeData(e.target.files[0], file, data);
                        }
                        input.click();
                    })
                } catch (error) {
                    console.log(error);
                    content.innerHTML = `<div style="color: red; padding: 20px;">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
            }

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            console.log('æŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:', extractedData);
            window.extractedData = extractedData; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜

            extractBtn.textContent = 'âœ“ æŠ½å‡ºå®Œäº†';
            extractBtn.disabled = false;
        });

        function switchTab(index) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const selectedTab = document.getElementById(`tab-${index}`);
            const selectedContent = document.getElementById(`content-${index}`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

    </script>
</body>

</html>